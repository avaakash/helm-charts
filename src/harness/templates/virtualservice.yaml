{{- if .Values.global.istio.enabled }}
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: harness-vs
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  gateways:
    {{- if .Values.global.istio.gateway.create }}
    - istio-system/public
    {{- else }}
    {{- range .Values.global.istio.virtualService.gateways }}
    - {{ . }}
    {{- end }}
    {{- end }}
  hosts:
    {{- range .Values.global.istio.virtualService.hosts }}
    - {{ . }}
    {{- end }}
  tcp:
  - match:
    - port: 9000
    route:
    - destination:
        host: log-service-minio
        port:
          number: 9000
  - match:
    - port: 9879
    route:
    - destination:
        host: harness-manager
        port:
          number: 9879
  http:
  - name: ng-manager
    match:
    - uri:
        prefix: /ng/api/
    - uri:
        prefix: /ng/api
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 7090
        host: ng-manager

  - name: et-collector
    match:
    - uri:
        prefix: /et-collector/
    - uri:
        prefix: /et-collector
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 6070
        host: et-collector.{{ .Release.Namespace }}.svc.cluster.local

  - name: et-service
    match:
    - uri:
        prefix: /et/
    - uri:
        prefix: /et
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 9191
        host: et-service

  - name: sto
    match:
    - uri:
        prefix: /sto/
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 4000
        host: sto-core
  - name: sto-manager
    match:
    - uri:
        prefix: /sto-manager/
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 7090
        host: sto-manager
  - name: next-gen-ui
    match:
    - uri:
        prefix: /ng/
    - uri:
        prefix: /ng
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 80
        host: next-gen-ui
  - name: ci-manager
    match:
    - uri:
        prefix: /ci/
    - uri:
        prefix: /ci
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 7090
        host: ci-manager

  - name: cv-nextgen
    match:
    - uri:
        prefix: /cv/
    - uri:
        prefix: /cv
    route:
    - destination:
        port:
          number: 6060
        host: cv-nextgen

  - name: minio-ui
    match:
    - uri:
        prefix: "/minio"
    route:
    - destination:
        port:
          number: 9000
        host: minio

  - name: log-serivce-minio
    match:
    - uri:
        prefix: "/logs/"
    route:
    - destination:
        port:
          number: 9000
        host: minio

  - name: log-service
    match:
    - uri:
        prefix: /log-service/
    - uri:
        prefix: /log-service
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 8079
        host: log-service

  # - name: gateway
  #   match:
  #   - uri:
  #       regex: "/gateway(/|$)(.*)"
  #   route:
  #   - destination:
  #       port:
  #         number: 80
  #       host: gateway

  - name: gateway
    match:
    - uri:
        prefix: /gateway/
    - uri:
        prefix: /gateway
    rewrite:
      uri: /
    route:
    - destination:
        host: gateway
        port:
          number: 80

  - name: access-control
    match:
    - uri:
        prefix: /authz/
    - uri:
        prefix: /authz
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 9006
        host: access-control

  - name: ti-service
    match:
    - uri:
        prefix: /ti-service/
    - uri:
        prefix: /ti-service
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 8078
        host: ti-service

  - name: template-service
    match:
    - uri:
        prefix: /template/
    - uri:
        prefix: /template
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 15002
        host: template-service

  - name: account-templates-v1-apis
    match:
    - uri:
        regex: "^/v1/templates(.*)$"
    rewrite:
      uri: "/api$1"
    route:
    - destination:
        host: template-service
        port:
          number: 15002

  - name: org-templates-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/templates(.*)$"
    rewrite:
      uri: "/api$1"
    route:
    - destination:
        host: template-service
        port:
          number: 15002

  - name: project-templates-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/templates(.*)$"
    rewrite:
      uri: "/api$1"
    route:
    - destination:
        host: template-service
        port:
          number: 15002

  - name: delegate-proxy
    match:
    - uri:
        prefix: "/storage"
    route:
    - destination:
        port:
          number: 80
        host: delegate-proxy


  - name: pipeline-service
    match:
    - uri:
        prefix: /pipeline/
    - uri:
        prefix: /pipeline
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 12001
        host: pipeline-service

  - name: pipelines-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/pipelines(.*)$"
    rewrite:
      uri: "/api$1"
    route:
    - destination:
        host: pipeline-service
        port:
          number: 12001

  - name: inputsets-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/input-sets(.*)$"
    rewrite:
      uri: "/api$1"
    route:
    - destination:
        host: pipeline-service
        port:
          number: 12001

  - name: approvals-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/approvals(.*)$"
    rewrite:
      uri: "/api$1"
    route:
    - destination:
        host: pipeline-service
        port:
          number: 12001

  - name: account-secrets-v1-apis
    match:
    - uri:
        regex: "^/v1/secrets(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: org-secrets-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/secrets(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: project-secrets-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/secrets(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: account-connectors-v1-apis
    match:
    - uri:
        regex: "^/v1/connectors(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: org-connectors-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/connectors(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: project-connectors-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/connectors(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: account-services-v1-apis
    match:
    - uri:
        regex: "^/v1/services(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: org-services-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/services(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: project-services-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/services(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: ip-allowlist-v1-apis
    match:
    - uri:
        regex: "^/v1/ip-allowlist(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: favorites-v1-apis
    match:
    - uri:
        regex: "^/v1/favorites(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: account-rancher-connectors-clusters-v1-apis
    match:
    - uri:
        regex: "^/v1/rancher/connectors/.+/clusters$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: account-rancher-infras-clusters-v1-apis
    match:
    - uri:
        regex: "^/v1/rancher/environments/.+/infrastructure-definitions/.+/clusters$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: org-rancher-connectors-clusters-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/rancher/connectors/.+/clusters$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: org-rancher-infras-clusters-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/rancher/environments/.+/infrastructure-definitions/.+/clusters$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: project-rancher-connectors-clusters-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/rancher/connectors/.+/clusters$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: project-rancher-infras-clusters-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/rancher/environments/.+/infrastructure-definitions/.+/clusters$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: account-roles-v1-apis
    match:
    - uri:
        regex: "^/v1/roles(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: access-control
        port:
          number: 9006

  - name: org-roles-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/roles(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: access-control
        port:
          number: 9006

  - name: project-roles-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/roles(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: access-control
        port:
          number: 9006

  - name: account-role-assignments-v1-apis
    match:
    - uri:
        regex: "^/v1/role-assignments(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: access-control
        port:
          number: 9006

  - name: org-role-assignments-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/role-assignments(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: access-control
        port:
          number: 9006

  - name: project-role-assignments-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/role-assignments(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: access-control
        port:
          number: 9006

  - name: account-resource-groups-v1-apis
    - uri:
        regex: "^/v1/resource-groups(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: platform-service
        port:
          number: 9005

  - name: org-resource-groups-v1-apis
    - uri:
        regex: "^/v1/orgs/.+/resource-groups(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: platform-service
        port:
          number: 9005

  - name: project-resource-groups-v1-apis
    - uri:
        regex: "^/v1/orgs/.+/projects/.+/resource-groups(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: platform-service
        port:
          number: 9005

  - name: streaming-destinations-v1-apis
    - uri:
        regex: "^/v1/streaming-destinations(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: platform-service
        port:
          number: 9005

  - name: projects-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs/.+/projects(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: orgs-v1-apis
    match:
    - uri:
        regex: "^/v1/orgs(.*)$"
    rewrite:
      uri: "$1"
    route:
    - destination:
        host: ng-manager
        port:
          number: 7090

  - name: notification-service
    match:
    - uri:
        prefix: /notifications/
    - uri:
        prefix: /notifications
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 9005
        host: platform-service

  - name: audit-service
    match:
    - uri:
        prefix: /audit/
    - uri:
        prefix: /audit
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 9005
        host: platform-service

  - name: resourcegroup-service
    match:
    - uri:
        prefix: /resourcegroup/
    - uri:
        prefix: /resourcegroup
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 9005
        host: platform-service

  - name: harness-manager-api
    match:
    - uri:
        #regex: "/api(/|$)(.*)"
        prefix: "/api"
    route:
    - destination:
        port:
          number: 9090
        host: harness-manager

  - name: blocking-swagger-api
    match:
    - uri:
        prefix: /api/swagger
    rewrite:
      uri: /
    route:
    - destination:
        host: dne
        port:
          number: 9999

  - name: harness-manager-stream
    match:
    - uri:
        #regex: "/stream(/|$)(.*)"
        prefix: "/stream"
    route:
    - destination:
        port:
          number: 9090
        host: harness-manager

  - name: grpc-manager
    match:
    - uri:
        prefix: "/"
      port: 9879
    route:
    - destination:
        port:
          number: 9879
        host: harness-manager

  - name: ng-auth-ui
    match:
    - uri:
        prefix: "/auth"
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 80
        host: ng-auth-ui
{{- if .Values.global.ff.enabled }}
  - name: ff-service
    match:
    - uri:
        prefix: /cf/
    - uri:
        prefix: /cf
    rewrite:
      uri: /api/1.0/
    route:
    - destination:
        port:
          number: 16001
        host: ff-service

  - name: ff-pushpin-service
    match:
    - uri:
        prefix: /sdk/
    - uri:
        prefix: /sdk
    rewrite:
      uri: /
    route:
    - destination:
        port:
          number: 17001
        host: ff-pushpin-service
{{- end }}
{{- if not .Values.global.cg.enabled }}
  - name: harness-ui
    match:
    - uri:
        prefix: "/"
    route:
    - destination:
        port:
          number: 80
        host: next-gen-ui
  - name: catchall-redirect
    match:
    - uri:
        regex: ".*"
    redirect:
      uri: "/"
{{- end }}
{{- end }}

